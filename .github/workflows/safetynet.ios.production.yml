name: SafetyNet iOS Production

on:
  # Only manual trigger for production
  workflow_dispatch:
    inputs:
      confirmation:
        description: 'Type "PRODUCTION" to confirm running tests on production'
        required: true

jobs:
  test-production:
    runs-on: macos-14
    timeout-minutes: 30
    # Only run if confirmation is correct
    if: github.event.inputs.confirmation == 'PRODUCTION'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'

      - name: Install and Verify Maestro
        run: |
          curl -Ls "https://get.maestro.mobile.dev" | bash
          export PATH="$HOME/.maestro/bin:$PATH"
          maestro --version
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH


      - name: Verify iOS app and test files exist
        run: |
          echo "=== Checking for Production iOS app ==="
          APP_DIR=$(find apps/safetynet/ios/production -name "*.app" -type d | head -1)
          if [ -z "$APP_DIR" ]; then
            echo "ERROR: No production .app bundle found!"
            ls -la apps/safetynet/ios/production/
            exit 1
          fi
          echo "Production iOS app found: $APP_DIR"
          ls -lh "$APP_DIR"

          echo "=== Checking for Production test files ==="
          if [ ! -d "tests/safetynet/ios/production/" ] || [ -z "$(ls -A tests/safetynet/ios/production/*.yaml 2>/dev/null)" ]; then
            echo "ERROR: No production tests found! Please create production test suite."
            exit 1
          fi
          ls -la tests/safetynet/ios/production/

      - name: List available iOS simulators
        run: |
          echo "=== Available iOS Simulators ==="
          xcrun simctl list devices available

      - name: Start iOS Simulator
        run: |
          set -e

          echo "=== Creating iPhone 15 Pro simulator if needed ==="
          DEVICE_ID=$(xcrun simctl create "iPhone-15-Pro-Test" "iPhone 15 Pro" "iOS17.5" 2>/dev/null || xcrun simctl list devices | grep "iPhone 15 Pro" | grep -v unavailable | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')

          if [ -z "$DEVICE_ID" ]; then
            echo "Finding existing iPhone 15 Pro simulator..."
            DEVICE_ID=$(xcrun simctl list devices | grep "iPhone 15 Pro" | grep -v unavailable | head -1 | grep -oE '\([A-F0-9-]+\)' | tr -d '()')
          fi

          if [ -z "$DEVICE_ID" ]; then
            echo "ERROR: Could not create or find iPhone 15 Pro simulator"
            exit 1
          fi

          echo "Using simulator: $DEVICE_ID"
          echo "SIMULATOR_ID=$DEVICE_ID" >> $GITHUB_ENV

          echo "=== Booting simulator ==="
          xcrun simctl boot "$DEVICE_ID" || echo "Simulator already booted"

          echo "=== Waiting for simulator to be ready ==="
          for i in {1..60}; do
            if xcrun simctl bootstatus "$DEVICE_ID" 2>&1 | grep -q "Device already booted"; then
              echo "Simulator is ready!"
              break
            fi
            echo "Waiting for simulator boot... ($i/60)"
            sleep 2
          done

          echo "=== Simulator status ==="
          xcrun simctl list devices | grep "$DEVICE_ID"

      - name: Install iOS app on simulator
        run: |
          set -e
          APP_DIR=$(find apps/safetynet/ios/production -name "*.app" -type d | head -1)
          echo "=== Installing Production iOS app on simulator: $APP_DIR ==="
          xcrun simctl install "$SIMULATOR_ID" "$APP_DIR"

          echo "=== Verifying app installation ==="
          xcrun simctl listapps "$SIMULATOR_ID" | grep -i safetynet || echo "Note: App installed but not found in list (may be normal)"

      - name: Run Maestro Tests
        env:
          # Production credentials from GitHub Secrets
          MAESTRO_USERNAME: ${{ secrets.SAFETYNET_PROD_USER }}
          MAESTRO_PASSWORD: ${{ secrets.SAFETYNET_PROD_PASSWORD }}
        run: |
          set -e
          export PATH="$HOME/.maestro/bin:$PATH"

          echo "=== Checking Maestro ==="
          which maestro
          maestro --version

          echo "=== Running PRODUCTION Tests ==="
          maestro test tests/safetynet/ios/production/ --format junit --output maestro-report.xml

          echo "=== Production tests completed ==="

      - name: Shutdown simulator
        if: always()
        run: |
          if [ ! -z "$SIMULATOR_ID" ]; then
            echo "=== Shutting down simulator ==="
            xcrun simctl shutdown "$SIMULATOR_ID" || echo "Simulator already shut down"
          fi

      - name: Upload Maestro Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safetynet-ios-production-test-results
          path: |
            maestro-report.xml
            ~/.maestro/tests/**/*
            **/*.mp4
          retention-days: 30  # Keep production results longer
          if-no-files-found: warn

      - name: Upload Maestro Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: safetynet-ios-production-logs
          path: |
            ~/.maestro/logs/**/*
          retention-days: 30
          if-no-files-found: warn

      - name: Notify on Failure
        if: failure()
        run: |
          echo "⚠️ PRODUCTION TESTS FAILED ⚠️"
          echo "Please investigate immediately!"
